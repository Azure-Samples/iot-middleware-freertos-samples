@startuml Azure IoT HFSM

state AzureIot {
    state Idle
    
    state Provisioning
    Provisioning: <b>entry/</b>
    Provisioning : \t retryCount = 0
    Provisioning : \t startSeconds = startstopwatch()
    Provisioning : \t initialize timer
    Provisioning :
    Provisioning : <b>exit/</b>
    Provisioning : \t destroy timer
    Provisioning :
    Provisioning : <b>AZ_IOT_ERROR/</b>
    Provisioning :  \t retryCount++
    Provisioning :  \t elapsedSeconds = getSeconds() - startSeconds
    Provisioning : \t if (retriable_error()) {
    Provisioning : \t\t start timer(calculate_retry_delay(elapsedSeconds, retryCount))
    Provisioning : \t }
    Provisioning : \t else {
    Provisioning : \t\t credential_idx = rotate_dps_credentials()
    Provisioning:  \t\t startSeconds = startstopwatch()
    Provisioning : \t\t start_provisioning()
    Provisioning : \t }
    Provisioning :
    Provisioning : <b>TIMEOUT/</b>
    Provisioning :  \t startSeconds = startstopwatch()
    Provisioning : \t start_provisioning()

    state Hub
    Hub : <b>entry/</b>
    Hub : \t retryCount = 0
    Hub : \t startSeconds = startstopwatch()
    Hub : \t initialize timer
    Hub :
    Hub : <b>exit/</b>
    Hub : \t destroy timer
    Hub : 
    Hub : <b>AZ_IOT_ERROR/</b>
    Hub : \t retryCount++
    Hub : \t elapsedSeconds = getSeconds() - startSeconds
    Hub : \t if (retriable_error) {
    Hub : \t\t start(delayTimer(calculate_retry_delay(elapsedSeconds, retryCount)))
    Hub : \t }
    Hub : \t else {
    Hub : \t\t start_provisioning()
    Hub : \t\t ^^AZ_IOT_START
    Hub : \t }
    Hub :
    Hub : <b>TIMEOUT/</b>
    Hub : \t startSeconds = startstopwatch()
    Hub : \t start_hub()
    
    [*] -> Idle
    Idle --> Provisioning : AZ_IOT_START / start_provisioning()
    Provisioning --> Hub : AZ_IOT_PROVISIONING_DONE / start_hub()

    Hub -> Provisioning : AZ_IOT_START
}

AzureIot : <b>entry/</b> 
AzureIot : \t credential_idx = 0
AzureIot :
AzureIot : <b>ERROR/</b> reboot

@enduml
